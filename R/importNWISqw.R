#'Water-Quality Data
#'
#'Import discrete sample water-quality data from NWISweb.
#'
#' @description Valid groups are "all," "information," "physical," "cations," 
#'"anions," "nutrients," "microbiological," "biological," "metals," "nonmetals,"
#'"toxicity," "pesticides," "pcbs," "other organics," "radio chemicals,",
#'"stable isotopes," "sediment," and "population/community." Subject to
#'availability in the \code{readNWISqw} function in the \code{dataRetrieval}
#'package.
#'
#' @param sites a vector of the USGS station identifiers.
#' @param params A character string contains the name of a group of parameter
#'codes, or a vector of parameter codes. See \bold{Details}.
#' @param begin.date the earliest date for data, must be a character with the
#'format "YYYY-mm-dd."
#' @param end.date the latest date for data, must be a character with the format
#'"YYYY-mm-dd."
#' @param keep a character vector for any additional columns to retain from the
#'retrieved data.
#' @param use.pnames create colummn names based on pcode (like P00000)? Default
#'is to generate more English-like names.
#' @return A data frame of the water-quality data of class "qw" organized by
#'sample. Column names for the water-quality constituents are generated 
#'automatically, but can be set by the user,
#'see \code{\link{makeColNames}}.
#' @note The sample information columns that are automatically retained are the 
#'USGS station identifier, sample date, sample time, time zone code, and medium
#'code. If composite samples are found in the data, then sample end date and 
#'sample end time are also included. Use the \code{keep} argument to retain more 
#'if needed.\cr
#'
#'NWIS has several remark codes that have special meaning in addition to "<," which
#'indicates a left-censored value and ">," which indicates a right censored value.
#'Most other codes are ignored in processing, but passed through and retained as the
#'remark code in the data; a warning is printed when special remark codes are retained.
#'NWIS also uses the remark code "M" to indicate whan a result value is rounded to 0. In
#'that case, \code{importNWISqw} tries to recode the data as less than the reportiong 
#'level, but is the reporting level is the missing value \code{NA}, the remark code "M"
#'is retained. Warnings are generated for both conversion and retention of the "M"
#'remark codes.
#'
#' @seealso \code{\link{readNWISqw}}
#' @references Lorenz, D.L., 2014, smwrQW OFR.\cr See information about discrete
#'samples at \url{http://nwis.waterdata.usgs.gov/usa/nwis/qw}.
#' @keywords datasets IO
#' @examples
#'
#'\dontrun{
#'importNWISqw("05330000", "00608") # Ammonia samples from the Minnesota River at Jordan.
#'}
#' @import dataRetrieval
#' @export
importNWISqw <- function(sites, params="all", begin.date="", end.date="",
                         keep=NULL, use.pnames=FALSE) {
  ## Coding history:
  ##    2012Sep17 DLLorenz original Coding
  ##    2013Jan26 DLLorenz Added option to use Pcode names
  ##    2014Oct07 DLLorenz Added pcodes to convert to numeric
	##
	## Numeric pcodes: These are almost all INFO and many PHYSICAL groups
	NPCd <- c("00001","00002","00003","00004","00005","00008","00009","00010","00011","00012","00013","00014",
						"00020","00021","00022","00023","00024","00025","00028","00029","00030","00031","00032","00034",
						"00035","00036","00041","00042","00045","00046","00047","00048","00049","00050","00051","00052",
						"00053","00054","00055","00056","00058","00059","00060","00061","00062","00063","00064","00065",
						"00067","00072","00074","00075","00085","00086","00090","00094","00095","00096",
						"00098","00100","00115","00117","00118","00119","00120","00121","00122","00123","00124","00125",
						"00126","00127","00128","00129","00132","00134","00135","00164","00193","00196","00197","00198",
						"00199","00200","00201","00206","00207","00325","00330","00400","00401","00403","00408","00434",
						"00480","00495","00898","00900","00901","00902","00903","00904","00905","00906","00907","00908",
						"00909","01305","01310","01315","01320","01325","01330","01335","01345","01350","01351","01355",
						"04117","04118","04119","04120","04121","30205","30206","30207","30208","30209","30210","30211",
						"30212","30213","30214","30215","30216","30267","30333","30334","32000","32001","32002","32290",
						"32300","32301","32302","32303","32306","32308","32312","32313","32325","32326","34777","45001",
						"45002","45003","45584","45585","45586","45587","45588","45589","45590","45591","45592","45700",
						"46253","46311","46514","46515","46516","46529","49261","49264","49275","49276","49277","49278",
						"49279","49280","49281","49282","49491","49701","49956","49957","49958","49959","49982","49983",
						"49984","49985","49986","50011","50012","50013","50014","50015","50016","50042","50047","50048",
						"50050","50051","50052","50054","50055","50086","50276","50277","50280","50292","50293","50294",
						"50414","50415","50416","50417","50418","50419","51102","51331","51332","51333","51334","51335",
						"51336","51337","51338","51339","51340","51341","51342","51343","51344","51345","51346","51918",
						"51919","51920","51921","51922","51923","51924","51925","51926","51927","51928","51929","51930",
						"51931","51932","51933","51934","51935","51936","51937","51938","51939","51940","51941","51942",
						"51943","51944","51945","51946","51947","51948","51949","51950","51951","51952","51953","51954",
						"51955","51956","51957","51958","51959","51960","51961","51962","51963","51964","51965","51966",
						"51967","51968","51969","51970","51971","51972","51973","51974","51975","51976","51977","51978",
						"51979","51980","51981","51982","51983","51984","51985","51986","51987","51988","51989","51990",
						"51991","51992","52000","52001","61035","61055","61727","61728","61729","62535","62536","62537",
						"62594","62595","62596","62597","62598","62599","62600","62601","62602","62603","62604","62605",
						"62606","62607","62608","62609","62610","62611","62612","62613","62614","62615","62616","62617",
						"62618","62619","62620","62621","62622","62623","62624","62625","62835","62836","62837","62838",
						"62839","62840","62841","62842","62846","62856","62923","62924","62925","62926","62927","62928",
						"62929","62930","62931","62932","62933","62934","62935","62936","62937","62938","62939","62940",
						"62941","62942","62943","62947","62948","62949","62955","62966","62967","62968","62969","62970",
						"62980","63001","63002","63158","63159","63160","63161","63740","64094","64466","65225","65237",
						"67308","67309","67310","67311","67312","67313","68043","68044","68045","68735","68921","68922",
						"68923","70001","70218","70219","70224","70227","70302","70303","70310","70320","70969","70971",
						"71820","71860","71994","71995","71996","71997","71998","71999","72000","72001","72002","72003",
						"72004","72005","72006","72008","72010","72012","72013","72014","72015","72016","72019","72020",
						"72021","72022","72023","72024","72025","72027","72028","72029","72036","72040","72050","72051",
						"72053","72103","72104","72105","72106","72111","72112","72113","72114","72115","72116","72117",
						"72118","72119","72120","72121","72122","72123","72124","72125","72126","72127","72128","72129",
						"72130","72131","72132","72133","72134","72135","72136","72137","72138","72139","72145","72147",
						"72148","72149","72150","72151","72152","72153","72154","72155","72156","72157","72158","72159",
						"72160","72161","72162","72163","72164","72165","72166","72167","72168","72169","72170","72171",
						"72172","72173","72174","72175","72176","72177","72178","72179","72180","72181","72182","72183",
						"72184","72185","72186","72187","72189","72190","72191","72192","72193","72194","72195","72196",
						"72197","72198","72199","72200","72201","72202","72203","72204","72205","72206","72207","72211",
						"72212","72214","72215","72216","72217","72218","72219","72220","72221","72222","72223","72226",
						"72227","72228","72229","72230","72231","72232","72236","72237","72238","72239","72241","72242",
						"72243","72248","72249","72250","72251","74019","74082","74200","74207","75969","75970","75971",
						"75972","78890","78891","80110","81024","81025","81026","81027","81028","81029","81352","81356",
						"81380","81381","81395","81798","81799","81903","81904","81905","81907","81908","81909","81910",
						"81911","81912","81913","81914","81915","81916","81917","82015","82016","82047","82048","82049",
						"82050","82072","82073","82074","82075","82076","82127","82130","82131","82132","82133","82134",
						"82135","82136","82137","82259","82260","82261","82262","82263","82264","82265","82266","82283",
						"82284","82285","82292","82300","82301","82309","82310","82363","82371","82372","82373","82374",
						"82375","82376","82377","82378","82379","82380","82381","82398","82583","82632","82903","82916",
						"82923","83104","83105","83106","83107","83150","83151","83152","83153","83154","83155","83156",
						"83177","83198","83205","83386","83387","83388","83389","83432","83433","83434","83435","83436",
						"83437","83438","83459","84060","84143","84144","84145","84146","84147","84148","84149","84164",
						"84171","84172","84173","84174","84175","84179","84180","84181","84182","84183","85310","85311",
						"85328","85540","85541","85553","85554","85555","85557","85558","85559","85560","85583","85599",
						"85822","90003","90004","90005","90007","90010","90030","90034","90077","90094","90095","90096",
						"90198","90199","90200","90400","90500","90501","90502","90503","90504","90505","90506","90507",
						"90508","90509","90510","90511","90512","90513","90514","90515","90516","90517","90518","90519",
						"90520","90521","90522","90523","90524","90525","90526","90527","90528","90529","90530","90531",
						"90532","90533","90534","90535","90536","90537","90538","90539","90540","90541","90542","90543",
						"90544","90545","90546","90547","90548","90549","90550","90551","90552","90553","90554","90555",
						"90556","90557","90558","90559","90560","90561","90562","90563","90564","90565","90566","90567",
						"90568","90569","90570","90571","90572","90573","90574","90575","90576","90577","90578","90579",
						"90580","90581","90582","90583","90584","90585","90586","90587","90588","90589","90590","90591",
						"90592","90593","90594","90595","90596","90597","90598","90599","90600","90601","90602","90603",
						"90604","90605","90606","90607","90608","90609","90610","90611","90612","90613","90614","90615",
						"90616","90617","90618","90619","90620","90621","90622","90623","90624","90625","90626","90627",
						"90628","90629","90630","90631","90632","90633","90634","90635","90636","90637","90638","90639",
						"90640","90641","90642","90643","90644","90645","90646","90647","90648","90649","90650","90651",
						"90652","90653","90654","90655","90656","90657","90658","90659","90660","90661","90662","90663",
						"90664","90665","90666","90667","90668","90669","90670","90671","90672","90673","90674","90675",
						"90676","90677","90678","90679","90680","90681","90682","90683","90684","90685","90686","90687",
						"90688","90689","90690","90691","90692","90693","90694","90695","90696","90697","90698","90699",
						"90700","90701","90702","90703","90704","90705","90710","90711","90712","90730","90731","90732",
						"90733","90734","90735","90736","90737","90738","90739","90740","90741","90742","90743","90744",
						"90745","90746","90747","90748","90749","90750","90751","90752","90753","90754","90755","90756",
						"90757","90758","90759","90760","90761","90762","90763","90764","90765","90766","90767","90768",
						"90769","90770","90771","90772","90773","90774","90775","90776","90777","90778","90779","90780",
						"90781","90782","90785","90786","90787","90788","90789","90790","90791","90792","90793","90794",
						"90795","90796","90797","90798","90799","90800","90801","90802","90803","90804","90805","90806",
						"90807","90808","90809","90810","90811","90812","90813","90814","90815","90816","90817","90818",
						"90819","90820","90821","90822","90823","90824","90827","90828","90829","90832","90833","90834",
						"90835","90836","90837","90838","90839","90840","90841","90842","90843","90844","90845","90846",
						"90847","90848","90849","90850","90860","90862","91016","91017","91055","91056","91062","91063",
						"91064","91065","91100","91101","91102","91103","91107","91108","91109","91110","91111","91112",
						"91113","91114","91115","91116","91117","91118","91119","91120","91121","91122","91123","91124",
						"91125","91126","91127","91128","91129","91130","91131","91132","91133","91134","91135","91136",
						"91137","91138","91139","91140","91141","91142","91143","91144","91146","91147","91148","91149",
						"91150","91151","91152","91153","91154","91615","91616","91617","91618","91619","91620","91621",
						"91622","91623","91624","91625","91626","91627","91628","91629","91630","91631","91632","91633",
						"91634","91635","91636","91637","91638","91639","91640","91641","91642","91643","91644","91645",
						"91646","91647","91648","91649","91650","91651","91652","91653","91654","91655","91656","91657",
						"91658","91659","91660","91661","91662","91663","91664","91665","91666","91667","91668","91669",
						"91670","91671","91672","91673","91674","91675","91676","91677","91678","91679","91680","91681",
						"91682","91683","91684","91685","91686","91687","91688","91689","91690","91691","91692","91693",
						"91694","91695","91696","91697","91698","91699","91728","91729","91730","91731","91732","91733",
						"91734","91735","91736","91737","91738","91739","91740","91741","91742","91743","91744","91745",
						"91746","91747","91748","91749","91750","91751","91752","91753","91754","91755","91756","91757",
						"91758","91759","91760","91761","91762","91763","91764","91765","91766","91767","91768","91769",
						"91770","91771","91772","91773","91774","91775","91776","91777","91778","91779","91780","91781",
						"91782","91783","91784","91785","91786","91787","91788","91789","91790","91791","91792","91793",
						"91794","91795","91796","91797","91798","91799","91800","91801","91802","91803","91804","91805",
						"91806","91807","91808","91809","91810","91811","91812","91813","91814","91815","91816","91817",
						"91818","91819","91820","91821","91822","91823","91824","91825","91826","91827","91828","91829",
						"91830","91831","91832","91833","91834","91835","91836","91837","91838","91839","91840","91841",
						"91842","91843","91844","91845","91846","91847","91848","91849","91850","91851","91852","91853",
						"91854","91855","91856","91857","91858","91859","91860","91861","91862","91863","91864","91865",
						"91866","91867","91868","91869","91870","91871","91872","91873","91874","91875","91876","91877",
						"91878","91879","91880","91881","91882","91883","91884","91885","91886","91887","91888","91889",
						"91890","91891","91892","91893","91894","91895","91896","91897","91898","91899","91900","91901",
						"91902","91903","91904","91905","91906","91907","91908","91909","91910","91911","91912","91913",
						"91914","91915","91916","91917","91918","91919","91920","91921","91922","91923","91924","91925",
						"91926","91927","91928","91929","91930","91931","91932","91933","91934","91935","91936","91937",
						"91938","91939","91940","91941","91942","91943","91944","91945","91946","91947","91948","91949",
						"91950","91951","91952","91953","91954","91955","91956","91957","91958","91959","91960","91961",
						"91962","91963","91964","91965","91966","91967","91968","91969","91970","91971","91972","91973",
						"91974","91975","91976","91977","91978","91979","91980","91981","91982","91983","91984","91985",
						"91986","91987","91988","91989","91990","91991","91992","91993","91994","91995","91996","91997",
						"91998","91999","95100","95902","99019","99020","99030","99031","99060","99061","99064","99065",
						"99066","99067","99100","99101","99102","99103","99104","99105","99106","99107","99108","99109",
						"99110","99111","99112","99150","99151","99152","99153","99154","99155","99156","99157","99158",
						"99159","99160","99161","99162","99163","99164","99165","99166","99167","99168","99169","99170",
						"99171","99172","99173","99174","99175","99176","99177","99200","99201","99202","99203","99204",
						"99205","99206","99207","99221","99222","99223","99224","99225","99226","99227","99228","99229",
						"99230","99231","99232","99233","99234","99235","99236","99237","99238","99239","99240","99241",
						"99242","99243","99244","99245","99246","99247","99248","99249","99250","99251","99252","99253",
						"99254","99255","99256","99257","99258","99259","99260","99261","99262","99300","99303","99570",
						"99571","99572","99573","99574","99575","99576","99577","99578","99579","99580","99581","99582",
						"99583","99584","99585","99586","99587","99588","99589","99590","99591","99592","99593","99594",
						"99610","99615","99620","99630","99631","99640","99646","99660","99661","99680","99700","99715",
						"99730","99750","99760","99772","99776","99777","99778","99779","99780","99781","99800","99801",
						"99802","99803","99804","99805","99806","99807","99808","99809","99810","99811","99812","99813",
						"99814","99815","99816","99817","99818","99819","99820","99821","99822","99823","99824","99825",
						"99826","99827","99828","99829","99831","99832","99833","99834","99835","99836","99837","99838",
						"99839","99840","99841","99847","99848","99849","99850","99851","99852","99853","99854","99855",
						"99856","99857","99858","99859","99860","99861","99862","99863","99864","99865","99866","99867",
						"99868","99869","99870","99871","99898","99899","99931","99932","99933","99934","99935","99936",
						"99937","99938","99939","99940","99941","99942","99943","99944","99945","99946","99947","99948",
						"99949","99950","99951","99952","99953","99954","99955","99956","99957","99958","99959","99961",
						"99962","99963","99964","99965","99966","99967","99968","99969","99970","99971","99972","99973",
						"99974","99975","99976","99978","99979","99980","99982","99983","99984","99986","99987","99988",
						"99989","99990","99991","99992","99993","99994","99995","99996","99997")
  ByResult <- readNWISqw(sites, params, begin.date, end.date, 
  											 expanded=TRUE, reshape=FALSE)
  if(use.pnames) {
    Extra <- pcodeNWISqw(params, group=FALSE, name=FALSE, CASRN=FALSE,
                       short=TRUE, units=TRUE, col.name=FALSE)
    Extra$col_name <- paste("P", Extra$parameter_cd, sep="")
  }
  else
    Extra <- pcodeNWISqw(params, group=FALSE, name=FALSE, CASRN=FALSE,
                         short=TRUE, units=TRUE, col.name=TRUE)
  ByResult <- merge(ByResult, Extra, by.x="parm_cd", by.y="parameter_cd")
  ## Create the qw column and the by sample dataset
  ByResult$qw <- as.qw(ByResult$result_va, ByResult$remark_cd,
                       ByResult$val_qual_tx,
                       ByResult$rpt_lev_va, ByResult$rpt_lev_cd,
                       ByResult$parameter_units, ByResult$meth_cd,
                       ByResult$srsname, ByResult$parm_cd)
  ## The function group2row cannot handle complicated data structures like qw
  ##  work around by creating index to values and then extract the actual data
  ByResult$Seq <- seq(nrow(ByResult))
  ## If composite samples are found in the mix, retain the end dates, times and tz
  if(any(!is.na(ByResult[["sample_end_dt"]]))) 
    keep <- c("sample_end_dt", "sample_end_tm", keep)
  Carry <- c("site_no", "sample_dt", "sample_tm", "sample_start_time_datum_cd", 
    "medium_cd", keep)
  retval <- group2row(ByResult, Carry, "col_name", "Seq")
  names(retval)[4L] <- "tzone_cd" # Make it simple
	for(i in grep(".Seq", names(retval), value=TRUE, fixed=TRUE)) {
		val <-ByResult$qw[retval[[i]]]
		## Work around some issues, need more robust criteria etc.
		if((val@unique.code[1L] %in% NPCd) && censoring(val) == "none") {
			retval[[i]] <- as.numeric(val)
		} else
			retval[[i]] <- val
	}
	names(retval) <- gsub(".Seq", "", names(retval), fixed=TRUE)
  ## Sort by date
  Seq <- order(retval$sample_dt, retval$sample_tm, na.last=TRUE)
  retval <- retval[Seq,]
  return(retval)
}
